{% extends 'base.html' %}
{% block content %}
  <h2>Setup Armies</h2>

  <!-- Team name form now includes Reset Rosters on the same row -->
  <form method="post" style="display: flex; align-items: center; gap: 1em; margin-bottom: 1.5em; width: 100%;">
    <label>
      Team 1 name:
      <input name="team1_name" value="{{ team1.name }}">
    </label>
    <label>
      Team 2 name:
      <input name="team2_name" value="{{ team2.name }}">
    </label>
    <button type="submit">Save Names</button>

    <!-- Reset Rosters button pushed to far right -->
    <button
      type="button"
      id="reset_rosters_btn"
      style="margin-left:auto; background:#c33; color:white;"
    >
      Reset Rosters
    </button>
  </form>

  <div class="flex">
    {% for side in ['team1','team2'] %}
      <div style="flex:1; border:1px solid #ccc; padding:1em; border-radius:8px; margin:0.5em;">
        <h3>{{ state[side].name }}</h3>

        <div>
          <label>Faction:</label><br>
          <select id="{{ side }}_faction">
            <option value="" disabled selected>-- choose faction --</option>
            {% for faction in ds_by_faction.keys() %}
              <option value="{{ faction }}">{{ faction.replace('-', ' ').title() }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Unit:</label><br>
          <select id="{{ side }}_unit" disabled>
            <option value="" disabled selected>-- choose unit --</option>
          </select>
        </div>

        <button id="{{ side }}_add" disabled>Add to {{ state[side].name }}</button>

        <h4>Roster</h4>
        <ul id="{{ side }}_roster_list">
          {% for path in state[side].roster %}
            {% set unit_label = path.split('/',1)[1][:-5] %}
            <li>
              {{ unit_label }}
              <span class="remove" onclick="(async()=>{
                await postJSON('/remove',{team:'{{side}}',path:'{{path}}'});
                this.parentElement.remove();
              })()">×</span>
            </li>
          {% endfor %}
        </ul>

        <script>
        (function(){
          const dsByFaction = {{ ds_by_faction|tojson }};
          const factionSel  = document.getElementById('{{ side }}_faction');
          const unitSel     = document.getElementById('{{ side }}_unit');
          const addBtn      = document.getElementById('{{ side }}_add');
          const rosterUL    = document.getElementById('{{ side }}_roster_list');

          factionSel.addEventListener('change', () => {
            const fac = factionSel.value;
            unitSel.innerHTML = '<option value="" disabled selected>-- choose unit --</option>';
            if (!fac || !dsByFaction[fac]) {
              unitSel.disabled = true;
              addBtn.disabled = true;
              return;
            }
            dsByFaction[fac].forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.path;
              opt.textContent = u.path.split('/')[1].slice(0,-5);
              unitSel.appendChild(opt);
            });
            unitSel.disabled = false;
            addBtn.disabled = true;
          });

          unitSel.addEventListener('change', () => {
            addBtn.disabled = !unitSel.value;
          });

          addBtn.addEventListener('click', async e => {
            e.preventDefault();
            const path  = unitSel.value;
            const label = unitSel.options[unitSel.selectedIndex].text;
            if (!path) return;
            await postJSON('/add', { team: '{{ side }}', path });
            const li = document.createElement('li');
            li.textContent = label;
            const span = document.createElement('span');
            span.textContent = '×';
            span.className = 'remove';
            span.onclick = async function(){
              await postJSON('/remove',{team:'{{side}}',path});
              this.parentElement.remove();
            };
            li.appendChild(span);
            rosterUL.appendChild(li);
            unitSel.selectedIndex = 0;
            addBtn.disabled = true;
          });
        })();
        </script>
      </div>
    {% endfor %}
  </div>

  <!-- Reset Rosters Script -->
  <script>
    document.getElementById('reset_rosters_btn').addEventListener('click', async () => {
      if (confirm('Are you sure you want to reset all rosters?')) {
        await postJSON('/reset_rosters', {});
        location.reload();
      }
    });
  </script>
{% endblock %}
