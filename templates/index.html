{% extends 'base.html' %}
{% block content %}
  <h2>Setup Armies</h2>
  <form method="post">
    <label>Team 1 name:
      <input name="team1_name" value="{{ team1.name }}">
    </label>
    &nbsp;
    <label>Team 2 name:
      <input name="team2_name" value="{{ team2.name }}">
    </label>
    <button type="submit">Save Names</button>
  </form>

  <div class="flex">
    {% for side in ['team1','team2'] %}
      <div style="flex:1; border:1px solid #ccc; padding:1em; border-radius:8px; margin:0.5em;">
        <h3>{{ state[side].name }}</h3>

        <!-- Faction selector -->
        <div>
          <label>Faction:</label><br>
          <select id="{{ side }}_faction">
            <option value="" disabled selected>-- choose faction --</option>
            {% for faction in ds_by_faction.keys() %}
              <option value="{{ faction }}">{{ faction.replace('-', ' ').title() }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Unit selector (no longer shows faction prefix) -->
        <div>
          <label>Unit:</label><br>
          <select id="{{ side }}_unit" disabled>
            <option value="" disabled selected>-- choose unit --</option>
          </select>
        </div>

        <button id="{{ side }}_add" disabled>Add to {{ state[side].name }}</button>

        <h4>Roster</h4>
        <ul id="{{ side }}_roster_list">
          {% for path in state[side].roster %}
            {% set unit_label = path.split('/',1)[1][:-5] %}
            <li>
              {{ unit_label }}
              <span class="remove" onclick="(async()=>{
                await postJSON('/remove',{team:'{{side}}',path:'{{path}}'});
                this.parentElement.remove();
              })()">×</span>
            </li>
          {% endfor %}
        </ul>

        <script>
        (function(){
          const dsByFaction = {{ ds_by_faction|tojson }};
          const factionSel  = document.getElementById('{{ side }}_faction');
          const unitSel     = document.getElementById('{{ side }}_unit');
          const addBtn      = document.getElementById('{{ side }}_add');
          const rosterUL    = document.getElementById('{{ side }}_roster_list');

          factionSel.addEventListener('change', () => {
            const fac = factionSel.value;
            unitSel.innerHTML = '<option value="" disabled selected>-- choose unit --</option>';
            if (!fac || !dsByFaction[fac]) {
              unitSel.disabled = true;
              addBtn.disabled = true;
              return;
            }
            // populate unit dropdown WITHOUT faction prefix
            dsByFaction[fac].forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.path;
              // derive unit name from filename
              const filename = u.path.split('/')[1];
              opt.textContent = filename.slice(0, -5);
              unitSel.appendChild(opt);
            });
            unitSel.disabled = false;
            addBtn.disabled = true;
          });

          unitSel.addEventListener('change', () => {
            addBtn.disabled = !unitSel.value;
          });

          addBtn.addEventListener('click', async e => {
            e.preventDefault();
            const path     = unitSel.value;
            const filename = path.split('/')[1];
            const label    = filename.slice(0, -5);
            if (!path) return;

            await postJSON('/add', { team: '{{ side }}', path });

            // add to roster list with a delete ×
            const li = document.createElement('li');
            li.textContent = label;
            const span = document.createElement('span');
            span.textContent = '×';
            span.className = 'remove';
            span.onclick = async function(){
              await postJSON('/remove',{team:'{{side}}',path});
              this.parentElement.remove();
            };
            li.appendChild(span);
            rosterUL.appendChild(li);

            // reset only the unit selector
            unitSel.selectedIndex = 0;
            addBtn.disabled      = true;
            // leave unitSel enabled so you can pick another unit
          });
        })();
        </script>
      </div>
    {% endfor %}
  </div>
{% endblock %}
